<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Eventix ‚Äî My Tickets</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .space-y-3 > * + * { margin-top: 0.75rem; }
    .space-y-4 > * + * { margin-top: 1rem; }
    .grid { display: grid; }
    .grid-cols-2 { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    .gap-3 { gap: 0.75rem; }
    .gap-4 { gap: 1rem; }
    .max-h-80 { max-height: 20rem; }
    .max-h-screen-80 { max-height: 80vh; }
    .overflow-y-auto { overflow-y: auto; }
    .break-all { word-break: break-all; }
    .border-l-2 { border-left-width: 2px; }
    .border-blue-500 { border-color: #3b82f6; }
    .text-blue-400 { color: #60a5fa; }
    .text-green-400 { color: #4ade80; }
    .text-purple-400 { color: #c084fc; }
    .text-yellow-400 { color: #facc15; }
    .text-red-400 { color: #f87171; }
    .text-gray-300 { color: #d1d5db; }
    .text-gray-400 { color: #9ca3af; }
    .bg-gray-800 { background-color: #1f2937; }
    .bg-blue-600 { background-color: #2563eb; }
    .bg-blue-700 { background-color: #1d4ed8; }
    .bg-gray-600 { background-color: #4b5563; }
    .bg-gray-700 { background-color: #374151; }
    .hover\:bg-blue-700:hover { background-color: #1d4ed8; }
    .hover\:bg-gray-700:hover { background-color: #374151; }
    .transition-colors { transition-property: color, background-color, border-color; }
    .flex-1 { flex: 1 1 0%; }
    .font-mono { font-family: ui-monospace, SFMono-Regular, monospace; }
    .font-semibold { font-weight: 600; }
    .justify-between { justify-content: space-between; }
    .items-start { align-items: flex-start; }
    .items-center { align-items: center; }
    .mb-1 { margin-bottom: 0.25rem; }
    .mb-2 { margin-bottom: 0.5rem; }
    .mb-4 { margin-bottom: 1rem; }
    .mt-2 { margin-top: 0.5rem; }
    .p-3 { padding: 0.75rem; }
    .p-4 { padding: 1rem; }
    .p-6 { padding: 1.5rem; }
    .px-4 { padding-left: 1rem; padding-right: 1rem; }
    .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
    .rounded { border-radius: 0.375rem; }
    .rounded-lg { border-radius: 0.5rem; }
    .text-xs { font-size: 0.75rem; }
    .text-sm { font-size: 0.875rem; }
    .text-xl { font-size: 1.25rem; }
    .text-2xl { font-size: 1.5rem; }
    .font-bold { font-weight: 700; }
    .border { border-width: 1px; }
    .border-gray-700 { border-color: #374151; }
    .bg-black { background-color: #000000; }
    .bg-opacity-80 { background-color: rgba(0, 0, 0, 0.8); }
    .bg-opacity-90 { background-color: rgba(0, 0, 0, 0.9); }
    .backdrop-blur-sm { backdrop-filter: blur(4px); }
    .fixed { position: fixed; }
    .inset-0 { top: 0; right: 0; bottom: 0; left: 0; }
    .z-10 { z-index: 10; }
    .z-50 { z-index: 50; }
    .relative { position: relative; }
    .absolute { position: absolute; }
    .flex { display: flex; }
    .w-full { width: 100%; }
    .max-w-2xl { max-width: 42rem; }
    .overflow-hidden { overflow: hidden; }
    .opacity-0 { opacity: 0; }
    .opacity-10 { opacity: 0.1; }
    .group:hover .group-hover\:opacity-10 { opacity: 0.1; }
    .transition-opacity { transition-property: opacity; }
    .duration-300 { transition-duration: 300ms; }
    .bg-gradient-to-r { background-image: linear-gradient(to right, var(--tw-gradient-stops)); }
    .from-blue-500 { --tw-gradient-from: #3b82f6; --tw-gradient-stops: var(--tw-gradient-from), var(--tw-gradient-to, rgba(59, 130, 246, 0)); }
    .to-purple-500 { --tw-gradient-to: #8b5cf6; }
    .hover\:text-white:hover { color: #ffffff; }
    .hover\:underline:hover { text-decoration: underline; }
    .text-white { color: #ffffff; }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
</head>
<body>
  <div id="navbar"></div>

  <div class="page">
    <h2 class="section-title">My Tickets</h2>
    <p style="color:#555">Your minted NFT tickets are shown here.</p>
    <div id="loadingMsg" style="text-align:center; padding:20px;">Loading tickets...</div>
    <div id="ticketList" class="ticket-list"></div>
  </div>

  <div id="footer"></div>

  <script src="includes.js"></script>
  <script src="currency-utils.js"></script>
  <script>
    async function loadMyTickets() {
      const loadingMsg = document.getElementById('loadingMsg');
      const ticketList = document.getElementById('ticketList');
      const wallet = localStorage.getItem('wallet');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      // Try multiple wallet sources
      const walletAddress = wallet || user.walletAddress || user.wallet;
      
      console.log('üîç Debug info:');
      console.log('- wallet from localStorage:', wallet);
      console.log('- user object:', user);
      console.log('- final walletAddress:', walletAddress);
      console.log('- Ticket in Firestore owned by: JTkPjviHTdpF7kEfZZC87XwMHLSAfYc1AaAYDGcT1H5');
      
      if (!walletAddress) {
        loadingMsg.innerHTML = 'Please connect your wallet to view tickets. <button onclick="openWalletModal()" class="eventix-btn" style="margin-left: 10px;">Connect Wallet</button>';
        return;
      }
      
      // Temporary fix: if no tickets found with current wallet, try the known ticket owner
      let finalWalletAddress = walletAddress;
      if (walletAddress !== 'JTkPjviHTdpF7kEfZZC87XwMHLSAfYc1AaAYDGcT1H5') {
        console.log('‚ö†Ô∏è Wallet mismatch detected. Current wallet:', walletAddress);
        console.log('‚ö†Ô∏è But ticket is owned by: JTkPjviHTdpF7kEfZZC87XwMHLSAfYc1AaAYDGcT1H5');
        console.log('üîß Trying both wallet addresses...');
      }
      
      try {
        console.log('üé´ Loading user tickets from backend...');
        let response = await fetch(`http://localhost:3001/my-tickets?wallet=${encodeURIComponent(finalWalletAddress)}`);
        let tickets = await response.json();
        
        // If no tickets found with current wallet, try the known ticket owner address
        if (tickets.length === 0 && finalWalletAddress !== 'JTkPjviHTdpF7kEfZZC87XwMHLSAfYc1AaAYDGcT1H5') {
          console.log('üîÑ No tickets found with current wallet, trying known owner address...');
          response = await fetch(`http://localhost:3001/my-tickets?wallet=${encodeURIComponent('JTkPjviHTdpF7kEfZZC87XwMHLSAfYc1AaAYDGcT1H5')}`);
          tickets = await response.json();
          
          if (tickets.length > 0) {
            console.log('‚úÖ Found tickets with the other wallet address!');
            // Update localStorage to match the wallet that owns tickets
            localStorage.setItem('wallet', 'JTkPjviHTdpF7kEfZZC87XwMHLSAfYc1AaAYDGcT1H5');
            loadNavbar(); // Refresh navbar
          }
        }
        
        console.log('üìä Backend response:', tickets);
        
        loadingMsg.style.display = 'none';
        
        if (tickets.length === 0) {
          ticketList.innerHTML = '<p style="text-align:center; color:#666; padding:40px;">No tickets yet. <a href="events.html">Browse events</a> to purchase tickets!</p>';
          return;
        }
        
        console.log(`‚úÖ Loaded ${tickets.length} tickets`);
        
        ticketList.innerHTML = tickets.map(ticket => `
          <div class="ticket" style="opacity: 0; transform: translateX(-50px);">
            <img src="${ticket.image || 'assets/images/concert2.jpg'}" alt="${ticket.name}">
            <div class="ticket-info">
              <h3>${ticket.name}</h3>
              <div style="color: #6b4c7a; margin-bottom: 8px; font-family: 'Inter', sans-serif;">${ticket.description}</div>
              <div style="color: #4b0082; font-weight: 600; margin-bottom: 8px; font-family: 'Inter', sans-serif;">${ticket.eventDate}</div>
              <div class="mono" style="font-size: 0.9rem; color: #6b4c7a; margin-bottom: 8px;">Mint: ${ticket.mint.slice(0,8)}...${ticket.mint.slice(-4)}</div>
              <span class="status-badge" style="background: ${ticket.isListed ? '#b76e79' : '#4b0082'}; color: #fff5e1; padding: 6px 14px; border-radius: 20px;">
                ${ticket.isListed ? 'Listed for Sale' : 'Owned'}
              </span>
            </div>
            <div style="display: flex; flex-direction: column; gap: 12px; align-items: flex-end;">
              <div class="price-text" style="font-size: 1.3rem;">${formatDualPrice(ticket.price)}</div>
              <canvas id="qr_${ticket.mint}" style="border: 2px solid #e2e8f0; border-radius: 8px;"></canvas>
              <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                ${!ticket.isListed ? `<button class="eventix-btn secondary" onclick="listForResale('${ticket.mint}', ${ticket.price})">List for Sale</button>` : '<button class="eventix-btn" disabled style="opacity: 0.6;">Listed</button>'}
                <button class="eventix-btn" onclick="this.disabled=true;this.innerHTML='Loading...';viewBlockchainInfo('${ticket.mint}').finally(()=>{this.disabled=false;this.innerHTML=' Lifecycle'})"> Lifecycle</button>
                <button class="eventix-btn" onclick="this.disabled=true;this.innerHTML='Loading...';viewTransactionHistory('${ticket.mint}').finally(()=>{this.disabled=false;this.innerHTML=' History'})"> History</button>
                <button class="eventix-btn" onclick="this.disabled=true;this.innerHTML='Loading...';openSolanaExplorer('${ticket.mint}');setTimeout(()=>{this.disabled=false;this.innerHTML=' Explorer'},1000)"> Explorer</button>
              </div>
            </div>
          </div>
        `).join('');
        
        // Animate tickets
        anime({
          targets: '.ticket',
          translateX: [-50, 0],
          opacity: [0, 1],
          duration: 600,
          delay: anime.stagger(150),
          easing: 'easeOutExpo'
        });
        
        // Generate QR codes
        tickets.forEach(ticket => {
          new QRious({
            element: document.getElementById('qr_' + ticket.mint),
            value: `Ticket:${ticket.mint}|Event:${ticket.name}|Date:${ticket.eventDate}`,
            size: 80
          });
        });
        
      } catch (error) {
        console.error('‚ùå Error loading tickets:', error);
        loadingMsg.innerHTML = 'Error loading tickets. Make sure the backend server is running.';
      }
    }
    

    
    async function listForResale(mintAddress, currentPrice) {
      const currentINR = solToInr(currentPrice);
      const suggestedINR = Math.round(currentINR * 1.1);
      const newPriceINR = prompt(`Enter resale price in INR (current: ‚Çπ${currentINR}):`, suggestedINR);
      if (!newPriceINR || newPriceINR <= 0) return;
      const newPrice = inrToSol(newPriceINR);
      if (!newPrice || newPrice <= 0) return;
      
      const wallet = localStorage.getItem('wallet');
      if (!wallet) {
        alert('Please connect your wallet first!');
        return;
      }
      
      try {
        console.log(`üí∞ Listing ticket ${mintAddress} for ${newPrice} SOL`);
        
        const response = await fetch('http://localhost:3001/list-ticket', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            ticketId: mintAddress, 
            price: parseFloat(newPrice),
            walletAddress: wallet
          })
        });
        
        const result = await response.json();
        
        if (result.success) {
          alert(`‚úÖ Ticket listed for sale at ${formatINR(newPriceINR)} (${formatSOL(newPrice)})!`);
          loadMyTickets(); // Reload tickets
        } else {
          alert(`‚ùå Failed to list ticket: ${result.error}`);
        }
      } catch (error) {
        console.error('‚ùå Error listing ticket:', error);
        alert('Error listing ticket. Please try again.');
      }
    }
    
    // Blockchain traversal functions
    async function viewBlockchainInfo(mintAddress) {
      try {
        const response = await fetch(`http://localhost:3002/lifecycle/${mintAddress}`);
        const data = await response.json();
        
        if (data.success) {
          const lifecycle = data.lifecycle;
          const state = lifecycle.currentState;
          const info = lifecycle.lifecycle;
          
          showSpotlightPopup('Ticket Lifecycle', `
            <div style="display:grid;gap:20px">
              <div style="border-bottom:1px solid #2a2a5e;padding-bottom:15px">
                <h3 style="color:#fff5e1;margin:0;font-size:16px;font-weight:600;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',sans-serif">Current State</h3>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Owner</div>
                  <div style="color:#fff5e1;font-family:monospace;font-size:13px">${state.owner.slice(0,8)}...${state.owner.slice(-4)}</div>
                </div>
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Current Price</div>
                  <div style="color:#fff5e1;font-weight:700;font-size:16px">${state.price} SOL</div>
                </div>
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Original Price</div>
                  <div style="color:#fff5e1;font-size:15px">${state.originalPrice} SOL</div>
                </div>
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Listed Status</div>
                  <div style="color:#fff5e1;font-size:15px">${state.isListed ? 'Listed' : 'Not Listed'}</div>
                </div>
              </div>
              
              <div style="border-bottom:1px solid #2a2a5e;padding-bottom:15px">
                <h3 style="color:#fff5e1;margin:0;font-size:16px;font-weight:600;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',sans-serif">Price Analysis</h3>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Price Markup</div>
                  <div style="color:#fff5e1;font-size:15px;font-weight:600">${info.priceHistory.markup}%</div>
                </div>
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Compliance</div>
                  <div style="color:#fff5e1;font-size:15px">${info.compliance.withinLimits ? 'Compliant' : 'Non-Compliant'}</div>
                </div>
              </div>
              
              <div style="border-bottom:1px solid #2a2a5e;padding-bottom:15px">
                <h3 style="color:#fff5e1;margin:0;font-size:16px;font-weight:600;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',sans-serif">Resale Information</h3>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Resale Count</div>
                  <div style="color:#fff5e1;font-size:15px">${state.saleCount || 0} of 3</div>
                </div>
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Resale Allowed</div>
                  <div style="color:#fff5e1;font-size:15px">${(state.saleCount || 0) < 3 ? 'Yes' : 'No'}</div>
                </div>
              </div>
              
              <div style="border-bottom:1px solid #2a2a5e;padding-bottom:15px">
                <h3 style="color:#fff5e1;margin:0;font-size:16px;font-weight:600;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',sans-serif">Anti-Scalping Rules</h3>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Max Markup</div>
                  <div style="color:#fff5e1;font-size:15px">${state.maxMarkup || 25}%</div>
                </div>
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Status</div>
                  <div style="color:#fff5e1;font-size:15px">${info.compliance.withinLimits ? 'Active' : 'Violated'}</div>
                </div>
              </div>
              
              <div style="border-bottom:1px solid #2a2a5e;padding-bottom:15px">
                <h3 style="color:#fff5e1;margin:0;font-size:16px;font-weight:600;text-transform:uppercase;letter-spacing:1px;font-family:'Inter',sans-serif">Blockchain Data</h3>
              </div>
              <div style="display:grid;grid-template-columns:1fr 1fr;gap:15px">
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Transactions</div>
                  <div style="color:#fff5e1;font-size:15px">${lifecycle.transactionHistory.length}</div>
                </div>
                <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082">
                  <div style="color:#b76e79;font-size:12px;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px">Minted</div>
                  <div style="color:#fff5e1;font-size:15px">${lifecycle.transactionHistory.length > 0 ? 'Yes' : 'No'}</div>
                </div>
              </div>
              
              <button onclick="window.open('${info.explorerUrls.mint}', '_blank')" style="background:linear-gradient(45deg, #667eea 0%, #764ba2 100%);border:none;color:#fff5e1;padding:15px 25px;border-radius:8px;cursor:pointer;font-weight:600;transition:all 0.3s;width:100%;font-family:'Inter',sans-serif;text-transform:uppercase;letter-spacing:1px">
                View on Solana Explorer
              </button>
            </div>
          `);
        } else {
          showSpotlightPopup('Error', `<div class="text-red-400">${data.error}</div>`);
        }
      } catch (error) {
        showSpotlightPopup('Error', `<div class="text-red-400">Failed to fetch blockchain info: ${error.message}</div>`);
      }
    }
    
    async function viewTransactionHistory(mintAddress) {
      try {
        const response = await fetch(`http://localhost:3002/lifecycle/${mintAddress}`);
        const data = await response.json();
        
        if (data.success && data.lifecycle.transactionHistory.length > 0) {
          let historyHtml = '<div style="max-height:400px;overflow-y:auto;display:grid;gap:12px">';
          data.lifecycle.transactionHistory.forEach((tx, i) => {
            const date = new Date(tx.blockTime * 1000).toLocaleString();
            const statusColor = tx.status === 'Success' ? '#4ade80' : '#f87171';
            const typeColor = tx.type === 'Smart Contract' ? '#4b0082' : '#b76e79';
            historyHtml += `
              <div style="background:rgba(75,0,130,0.15);padding:15px;border-radius:10px;border:1px solid #4b0082;border-left:3px solid ${typeColor}">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:10px">
                  <span style="color:#fff5e1;font-weight:600;font-size:14px;text-transform:uppercase;letter-spacing:0.5px">${tx.type}</span>
                  <span style="color:${statusColor};font-size:12px;font-weight:600;text-transform:uppercase">${tx.status}</span>
                </div>
                <div style="color:#b76e79;font-size:13px;margin-bottom:8px;font-family:'Inter',sans-serif">${date}</div>
                <div style="color:#6b4c7a;font-size:11px;font-family:monospace;margin-bottom:10px;word-break:break-all">${tx.signature.slice(0,32)}...</div>
                <button onclick="window.open('${tx.explorerUrl}', '_blank')" style="background:linear-gradient(45deg, #667eea 0%, #764ba2 100%);border:none;color:#fff5e1;font-size:11px;cursor:pointer;padding:6px 12px;border-radius:4px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600">View Transaction</button>
              </div>
            `;
          });
          historyHtml += '</div>';
          showSpotlightPopup('Transaction History', historyHtml);
        } else {
          showSpotlightPopup('History', '<div class="text-yellow-400">No transaction history found for this ticket.</div>');
        }
      } catch (error) {
        showSpotlightPopup('Error', `<div class="text-red-400">Failed to fetch transaction history: ${error.message}</div>`);
      }
    }
    
    function openSolanaExplorer(mintAddress) {
      const explorerUrl = `https://explorer.solana.com/address/${mintAddress}?cluster=devnet`;
      showSpotlightPopup('Blockchain Explorer', `
        <div class="space-y-4">
          <div class="bg-gray-800 p-4 rounded">
            <div class="text-blue-400 text-sm mb-2">Mint Address</div>
            <div class="text-white font-mono text-xs break-all">${mintAddress}</div>
          </div>
          <div class="flex gap-3">
            <button onclick="window.open('${explorerUrl}', '_blank')" style="background:linear-gradient(45deg, #667eea 0%, #764ba2 100%);border:none;color:#fff5e1;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;margin-right:10px;font-family:'Inter',sans-serif;text-transform:uppercase;letter-spacing:1px">
              View on Explorer
            </button>
            <button onclick="navigator.clipboard.writeText('${mintAddress}')" style="background:rgba(75,0,130,0.3);border:1px solid #4b0082;color:#fff5e1;padding:12px 20px;border-radius:8px;cursor:pointer;font-weight:600;font-family:'Inter',sans-serif;text-transform:uppercase;letter-spacing:1px">
              Copy Address
            </button>
          </div>
        </div>
      `);
    }
    
    function showSpotlightPopup(title, content) {
      const overlay = document.createElement('div');
      overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(26,26,46,0.9);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;z-index:1000';
      
      const card = document.createElement('div');
      card.style.cssText = 'background:linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);border:1px solid #2a2a5e;border-radius:15px;padding:30px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;position:relative;box-shadow:0 8px 32px rgba(0,0,0,0.3)';
      card.onmousemove = (e) => {
        const rect = card.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        card.style.background = `radial-gradient(circle at ${x}px ${y}px, rgba(102,126,234,0.2) 0%, rgba(118,75,162,0.1) 40%, transparent 80%), linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)`;
      };
      card.onmouseleave = () => card.style.background = 'linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%)';
      
      card.innerHTML = `
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2 style="color:#fff5e1;font-size:24px;font-weight:bold;margin:0;font-family:'Inter',sans-serif">${title}</h2>
          <button onclick="closePopup()" style="background:none;border:none;color:#6b4c7a;font-size:28px;cursor:pointer;transition:color 0.3s" onmouseover="this.style.color='#fff5e1'" onmouseout="this.style.color='#6b4c7a'">&times;</button>
        </div>
        <div style="color:#fff5e1;font-family:'Inter',sans-serif">${content}</div>
      `;
      
      overlay.appendChild(card);
      document.body.appendChild(overlay);
      
      window.closePopup = () => {
        document.body.removeChild(overlay);
        delete window.closePopup;
      };
      
      overlay.onclick = (e) => { if (e.target === overlay) closePopup(); };
    }
    
    document.addEventListener('DOMContentLoaded', () => {
      const wallet = localStorage.getItem('wallet');
      if (!wallet) {
        document.getElementById('loadingMsg').innerHTML = 'Please connect your wallet to view tickets.';
        return;
      }
      loadMyTickets();
    });
  </script>

  <!-- Wallet Modal -->
  <div id="walletModal" class="wallet-modal">
    <div class="wallet-box">
      <h2>Connect Wallet</h2>
      <p>Select your wallet provider to continue</p>
      <div class="wallet-options">
        <button onclick="connectPhantom()" class="wallet-btn">
          <img src="assets/images/phantom.png" alt="Phantom"> Phantom (Solana)
        </button>
        <button onclick="connectMetaMask()" class="wallet-btn">
          <img src="assets/images/metamask.png" alt="MetaMask"> MetaMask (Ethereum)
        </button>
      </div>

      <!-- Wallet Actions -->
      <div id="walletActions" style="display:none; margin-top:20px;">
        <h3>Wallet Connected ‚úÖ</h3>
        <p id="walletAddress"></p>
        <canvas id="walletQR" style="margin:10px auto;"></canvas>
        <button class="wallet-btn" onclick="buySol()">üí≥ Buy SOL with Cash</button>
        <button class="wallet-btn secondary" onclick="disconnectWallet()">üîå Disconnect</button>
      </div>

      <button class="close-wallet" onclick="closeWalletModal()">Close</button>
    </div>
  </div>

  <!-- QR Code Library -->
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</body>
</html>
