<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Events - Eventix</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
  <script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.min.js"></script>
  <script src="currency-utils.js"></script>
</head>
<body>
  <div id="navbar"></div>

  <div class="page">
    <h2 class="section-title">Available Events</h2>
    <p style="color:#555">Purchase tickets with SOL. Each ticket is minted as an NFT on Solana.</p>
    
    <div id="loadingMsg" style="text-align:center; padding:20px;">Loading events...</div>
    <div id="eventsList" class="event-cards"></div>
    
    <h2 class="section-title" style="margin-top: 60px;">Marketplace - Resale Tickets</h2>
    <p style="color:#555">Buy tickets from other users at market prices.</p>
    <div id="marketplaceList" class="event-cards"></div>
  </div>

  <div id="footer"></div>

  <!-- Purchase Modal -->
  <div id="purchaseModal" class="wallet-modal">
    <div class="wallet-box">
      <h2>Purchase Ticket</h2>
      <div id="ticketDetails"></div>
      <div style="margin: 20px 0;">
        <strong>Total: <span id="totalPrice"></span></strong>
      </div>
      <div id="purchaseButtons" style="display: flex; gap: 10px; justify-content: center;">
        <button id="confirmBtn" class="eventix-btn" onclick="confirmPurchase()">Confirm Purchase</button>
        <button class="eventix-btn secondary" onclick="closePurchaseModal()">Cancel</button>
      </div>
      <div id="loadingSpinner" style="display: none; text-align: center; margin: 20px 0;">
        <div class="loader-wrapper">
          <span class="loader-letter">G</span>
          <span class="loader-letter">e</span>
          <span class="loader-letter">n</span>
          <span class="loader-letter">e</span>
          <span class="loader-letter">r</span>
          <span class="loader-letter">a</span>
          <span class="loader-letter">t</span>
          <span class="loader-letter">i</span>
          <span class="loader-letter">n</span>
          <span class="loader-letter">g</span>
          <div class="loader"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="includes.js"></script>
  <script>
    let selectedTicket = null;
    let isMarketplacePurchase = false;

    async function loadEvents() {
      const loadingMsg = document.getElementById('loadingMsg');
      const eventsList = document.getElementById('eventsList');
      
      try {
        console.log('üé™ Loading available events...');
        const response = await fetch('https://eventix-backend1.onrender.com/available-tickets');
        const events = await response.json();
        
        loadingMsg.style.display = 'none';
        
        console.log(`‚úÖ Loaded ${events.length} events`);
        
        eventsList.innerHTML = events.map(event => `
          <div class="event-card" style="opacity: 0; transform: translateY(50px);">
            <img src="${event.image || 'concert2.jpg'}" alt="${event.name}">
            <div class="event-card-content">
              <div class="event-card-title">${event.name}</div>
              <div class="event-card-type">${event.description}</div>
              <div style="color: #4b0082; font-weight: 600; margin: 8px 0; font-family: 'Inter', sans-serif;">${event.eventDate}</div>
              <div class="price-text" style="margin: 8px 0;">${formatDualPrice(event.price)}</div>
              <button onclick="buyTicket('${event.id}', '${event.name}', '${event.description}', '${event.eventDate}', ${event.price})">
                Buy Ticket
              </button>
            </div>
          </div>
        `).join('');
        
        // Animate event cards
        anime({
          targets: '.event-card',
          translateY: [50, 0],
          opacity: [0, 1],
          duration: 600,
          delay: anime.stagger(100),
          easing: 'easeOutExpo'
        });
        
      } catch (error) {
        console.error('‚ùå Error loading events:', error);
        loadingMsg.innerHTML = 'Error loading events. Make sure the backend server is running.';
      }
    }

    async function loadMarketplace() {
      const marketplaceList = document.getElementById('marketplaceList');
      
      try {
        console.log('üè™ Loading marketplace listings...');
        const response = await fetch('https://eventix-backend1.onrender.com/marketplace');
        const listings = await response.json();
        
        console.log(`‚úÖ Loaded ${listings.length} marketplace listings`);
        
        if (listings.length === 0) {
          marketplaceList.innerHTML = '<p style="text-align:center; color:#666; padding:40px;">No tickets listed for resale yet.</p>';
          return;
        }
        
        marketplaceList.innerHTML = listings.map(ticket => `
          <div class="event-card" style="border: 2px solid #ff6b6b; opacity: 0; transform: translateY(30px);">
            <img src="${ticket.image || 'concert2.jpg'}" alt="${ticket.name}">
            <div class="event-card-content">
              <div class="event-card-title">${ticket.name}</div>
              <div class="event-card-type">${ticket.description}</div>
              <div style="color: #4b0082; font-weight: 600; margin: 8px 0; font-family: 'Inter', sans-serif;">${ticket.eventDate}</div>
              <div style="color: #b76e79; font-weight: 600; margin: 8px 0;">
                <span class="price-text">${formatDualPrice(ticket.price)}</span>
                ${ticket.price > ticket.originalPrice ? `<span class="mono" style="font-size:0.8rem; color:#6b4c7a;">(was ${formatDualPrice(ticket.originalPrice)})</span>` : ''}
              </div>
              <div class="mono" style="font-size: 0.8rem; color: #6b4c7a; margin: 4px 0;">
                Mint: ${ticket.mint.slice(0,8)}...${ticket.mint.slice(-4)}
              </div>
              <button onclick="buyFromMarketplace('${ticket.mint}', '${ticket.name}', '${ticket.description}', '${ticket.eventDate}', ${ticket.price})">
                Buy from Resale
              </button>
            </div>
          </div>
        `).join('');
        
        // Animate marketplace cards
        anime({
          targets: '#marketplaceList .event-card',
          translateY: [30, 0],
          opacity: [0, 1],
          duration: 500,
          delay: anime.stagger(80),
          easing: 'easeOutExpo'
        });
        
      } catch (error) {
        console.error('‚ùå Error loading marketplace:', error);
        marketplaceList.innerHTML = '<p style="text-align:center; color:#ff6b6b; padding:20px;">Error loading marketplace listings.</p>';
      }
    }

    function buyTicket(ticketType, name, description, eventDate, price) {
      const wallet = localStorage.getItem('wallet');
      if (!wallet) {
        alert('Please connect your wallet first!');
        openWalletModal();
        return;
      }
      
      selectedTicket = { ticketType, name, description, eventDate, price };
      isMarketplacePurchase = false;
      showPurchaseModal();
    }

    function buyFromMarketplace(mintAddress, name, description, eventDate, price) {
      const wallet = localStorage.getItem('wallet');
      if (!wallet) {
        alert('Please connect your wallet first!');
        openWalletModal();
        return;
      }
      
      selectedTicket = { mintAddress, name, description, eventDate, price };
      isMarketplacePurchase = true;
      showPurchaseModal();
    }

    function showPurchaseModal() {
      document.getElementById('purchaseModal').style.display = 'flex';
      document.getElementById('ticketDetails').innerHTML = `
        <div style="text-align: center; margin-bottom: 16px;">
          <h3>${selectedTicket.name}</h3>
          <p>${selectedTicket.description}</p>
          <p style="color: #6c47ff;">${selectedTicket.eventDate}</p>
          ${isMarketplacePurchase ? '<p style="color: #ff6b6b; font-weight: 600;">üîÑ Resale Ticket</p>' : '<p style="color: #51cf66; font-weight: 600;">üé´ New Ticket</p>'}
        </div>
      `;
      document.getElementById('totalPrice').innerHTML = formatDualPrice(selectedTicket.price);
    }

    function closePurchaseModal() {
      if (isPurchasing) return; // Prevent closing during purchase
      document.getElementById('purchaseModal').style.display = 'none';
      selectedTicket = null;
      hideLoadingState();
    }

    let isPurchasing = false;

    async function confirmPurchase() {
      if (!selectedTicket || isPurchasing) return;
      
      // Prevent multiple clicks
      isPurchasing = true;
      showLoadingState();
      
      const wallet = localStorage.getItem('wallet');
      
      try {
        console.log(`üí≥ Processing ${isMarketplacePurchase ? 'marketplace' : 'new'} purchase...`);
        
        let response;
        if (isMarketplacePurchase) {
          response = await fetch('https://eventix-backend1.onrender.com/buy-from-marketplace', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ticketId: selectedTicket.mintAddress,
              buyerWallet: wallet
            })
          });
        } else {
          response = await fetch('https://eventix-backend1.onrender.com/buy-ticket', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              ticketType: selectedTicket.ticketType,
              walletAddress: wallet
            })
          });
          
          console.log('üîç Purchase request sent:', {
            ticketType: selectedTicket.ticketType,
            walletAddress: wallet
          });
        }
        
        const result = await response.json();
        
        if (result.success) {
          if (result.requiresSignature && isMarketplacePurchase) {
            // Handle transaction signing for marketplace purchase
            try {
              const connection = new solanaWeb3.Connection('https://api.devnet.solana.com');
              const transaction = solanaWeb3.Transaction.from(Buffer.from(result.transaction, 'base64'));
              
              // Get wallet adapter
              if (window.solana && window.solana.isPhantom) {
                const signedTransaction = await window.solana.signTransaction(transaction);
                const signature = await connection.sendRawTransaction(signedTransaction.serialize());
                await connection.confirmTransaction(signature);
                
                alert(`‚úÖ Marketplace purchase successful! Transaction: ${signature.slice(0,8)}...`);
                loadMarketplace();
              } else {
                alert('‚ùå Phantom wallet not found. Please install Phantom wallet.');
              }
            } catch (signError) {
              console.error('Transaction signing failed:', signError);
              alert(`‚ùå Transaction signing failed: ${signError.message}`);
            }
          } else {
            const inrAmount = solToInr(selectedTicket.price);
            alert(`‚úÖ Purchase successful! Paid ${formatINR(inrAmount)} (${formatSOL(selectedTicket.price)}) ${isMarketplacePurchase ? 'Ticket transferred to your wallet.' : 'Ticket minted: ' + result.mintAddress.slice(0,8) + '...'}`);
            if (isMarketplacePurchase) {
              loadMarketplace();
            }
          }
          closePurchaseModal();
        } else {
          alert(`‚ùå Purchase failed: ${result.error}`);
        }
        
      } catch (error) {
        console.error('‚ùå Purchase error:', error);
        alert('Purchase failed. Please try again.');
      } finally {
        isPurchasing = false;
        hideLoadingState();
      }
    }

    function showLoadingState() {
      document.getElementById('purchaseButtons').style.display = 'none';
      document.getElementById('loadingSpinner').style.display = 'block';
    }

    function hideLoadingState() {
      document.getElementById('purchaseButtons').style.display = 'flex';
      document.getElementById('loadingSpinner').style.display = 'none';
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Animate page elements on load
      anime({
        targets: '.section-title',
        translateY: [-50, 0],
        opacity: [0, 1],
        duration: 800,
        easing: 'easeOutExpo'
      });
      
      loadEvents();
      loadMarketplace();
      
      // Refresh marketplace every 30 seconds
      setInterval(loadMarketplace, 30000);
    });
  </script>

  <!-- Wallet Modal -->
  <div id="walletModal" class="wallet-modal">
    <div class="wallet-box">
      <h2>Connect Wallet</h2>
      <p>Select your wallet provider to continue</p>
      <div class="wallet-options">
        <button onclick="connectPhantom()" class="wallet-btn">
          <img src="assets/images/phantom.png" alt="Phantom"> Phantom (Solana)
        </button>
        <button onclick="connectMetaMask()" class="wallet-btn">
          <img src="assets/images/metamask.png" alt="MetaMask"> MetaMask (Ethereum)
        </button>
      </div>
      <div id="walletActions" style="display:none; margin-top:20px;">
        <h3>Wallet Connected ‚úÖ</h3>
        <p id="walletAddress"></p>
        <canvas id="walletQR" style="margin:10px auto;"></canvas>
        <button class="wallet-btn" onclick="buySol()">üí≥ Buy SOL with Cash</button>
        <button class="wallet-btn secondary" onclick="disconnectWallet()">üîå Disconnect</button>
      </div>
      <button class="close-wallet" onclick="closeWalletModal()">Close</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
</body>
</html>